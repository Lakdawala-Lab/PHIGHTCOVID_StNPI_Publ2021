
1. import libraries 
```{r, message=FALSE, warning=FALSE, echo = FALSE}
# import libraries
library(tidyverse)
library(ggplot2)
library(dplyr)
library(readr)
library(ggfortify)
library(ggseas)
library(plotly)
library(zoo)
```



```{r, message=FALSE, warning=FALSE, echo = FALSE}
data <- read_csv("State_Cases_G1_Merged_20210413.csv") %>% 
  select(c("STATE","DATE","NEWCONFIRMED", "SCORE", "EVENT_CATG_S",
           "SHORT_DESCRIPT"))

state_pop_dt <- read_csv("USA_States_Data.csv") %>% 
  select(c("STATE_NAME", "POPULATION"))
colnames(state_pop_dt) <- c("STATE", "POPULATION")
data$DATE <- as.Date(data$DATE, format="%m/%d/%Y")
state_pop_dt$STATE <- toupper(state_pop_dt$STATE)
```

```{r}
data <- inner_join(data, state_pop_dt, by=c("STATE")) 
data$`NEWCD_NORM_500`<- round(data$NEWCONFIRMED/(data$POPULATION/500000))
```
```{r}
# function that splits event and find specific order
check_event <- function(x, event_order){
  orders = strsplit(x,",")[[1]]
  return(event_order %in% orders)
}

# group event categories into easing/lifting and imposing
group_event_catg <- function(x){
  new_col = c()
  check = substr(x, nchar(x), nchar(x))
  if(check %in% c("M", "R", "A")){
    new_col <- append(new_col, "Restricting")
  } else if (check %in% c("E", "L")){
    new_col <- append(new_col, "Easing")
  } else {
    new_col <- append(new_col, "")
  }
}

data$event_MLER <- sapply(data$EVENT_CATG_S, FUN=group_event_catg)
data[data$DATE=="2020-09-07",]$event_MLER <- "Labor Day"


# category num
catg_num <- function(x){
  new_col = c()
  if (is.na(x)){
    new_col <- append(new_col, x)
  } 
  else if(x=="15M"){
    new_col <- append(new_col, "Face Covering")
  } else if(grepl("2", x)){
    new_col <- append(new_col, "Business Restrictions")
  } else if(grepl("3", x)){
    new_col <- append(new_col, "Indoor Gathering Restrictions")
  } else if(grepl("4", x)){
    new_col <- append(new_col, "Restaurant/Bar Restrictions")
  } else{
    new_col <- append(new_col, "Stay at Home Orders")
  }
}

data$catogory_num <- sapply(data$EVENT_CATG_S, FUN=catg_num)

```

2. Create a function to plot first time issuing an order
```{r, warning=FALSE}
plot_first_issue <- function(states, window_num, y_axis_max, event_order,
                             event_order_name){
  master_df = data.frame()
  school_opening_df = data.frame()
  for (i in (1: length(states))){
    state_data <- data[data$STATE==states[i],]
    fourteen_days <- 14 # graph starts two weeks before 
    may_day <- as.Date("2020-05-01")
    state_data <- state_data[state_data$DATE>=may_day-fourteen_days,]
    state_data <- state_data %>%
      group_by(STATE, DATE) %>%
      summarise(Events = paste(EVENT_CATG_S, collapse = ","),
                Newcd_norm = mean(NEWCD_NORM_500),
                Events_mler = first(event_MLER),
                Score = mean(SCORE))
    
    # turn "NA" into NA
    state_data$Events[state_data$Events=="NA"] <- NA
    # index of first time issue of an order
    order_ind = which(sapply(state_data$Events, check_event, event_order))
  
    # if a state never issues an order we dont plot it
    # else the plot starts at 14 days before the order
    if(length(order_ind)>0 && order_ind>14){
      state_data = state_data[(order_ind-fourteen_days):
                                nrow(state_data),]
      # number of days since implementation
      state_data$Days =
        as.numeric(state_data$DATE-state_data$DATE[1]-fourteen_days)
      # append to final data for plotting
      master_df = rbind(master_df,as.data.frame(state_data))}
  } 
  # add a new column of moving average
  # otherwise interactive plot cannot show date
  master_df$newcd_norm_moving <- rollmean(master_df$Newcd_norm, window_num,
                                  fill=NA, align="right")
  event_master_df <- master_df[master_df$Events_mler!="",] 
  event_master_df$Events_mler <- factor(event_master_df$Events_mler,
                                        levels = c("Easing", "Restricting",
                                                   "Labor Day"))

  
  p <- ggplot() +
    geom_vline(xintercept=0) +
    geom_line(data = master_df, aes(x = Days, y = newcd_norm_moving,
                                    color = STATE), size = 1, 
              alpha = 0.8) +
    geom_point(data = event_master_df, aes(x = Days, y = newcd_norm_moving,
                                           shape=Events_mler),
               alpha = 1, size=4) +
    scale_color_discrete(name="State")+
    scale_shape_manual(name="Event Categories", values=c(16,17,4))+
    xlim(c(-14,100))+
    ylim(c(0,y_axis_max))+
    #scale_x_continuous(breaks = seq(-10,100, by = 20))+
    xlab(paste("Number of Days Since", event_order_name))+
    ylab("Normalized Daily New Cases") +
    ggtitle( paste("The First Time", event_order_name, "Issued After May, 2020", sep = " ") ) +
    theme_bw()+
    theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        title=element_text(size=16, face='bold'),
        legend.title=element_text(size=14, face="bold"),
        legend.text=element_text(size=12),
        legend.margin=margin(t = 0, unit='cm'))
  p
}

```


3. Create a function to plot last time issuing an order
```{r, warning=FALSE}
plot_last_issue <- function(states, window_num, y_axis_max, event_order,
                             event_order_name){
  master_df = data.frame()
  school_opening_df = data.frame()
  for (i in (1: length(states))){
    state_data <- data[data$STATE==states[i],]
    fourteen_days <- 14 # graph starts two weeks before 
    may_day <- as.Date("2020-05-01")
    state_data <- state_data[state_data$DATE>=may_day-fourteen_days,]
      state_data <- state_data %>%
    group_by(STATE, DATE) %>%
    summarise(Events = paste(EVENT_CATG_S, collapse = ","),
              Newcd_norm = mean(NEWCD_NORM_500),
              Events_mler = first(event_MLER),
              Score = mean(SCORE))
    
    # turn "NA" into NA
    state_data$Events[state_data$Events=="NA"] <- NA
    # index of first time issue of an order
    order_ind = which(sapply(state_data$Events, check_event, event_order))
    last_issue <- order_ind
    for (i in order_ind:nrow(state_data)){
      if (check_event(state_data[i,"Events"]$Events, event_order)){
        last_issue <- i
      }
    }
  
    # if a state never issues mask order then plot all data
    # else the plot starts at the day of mask order
    if(length(last_issue)>0){
      state_data = state_data[(last_issue-fourteen_days):nrow(state_data),]
      # number of days since implementation
      state_data$Days =
        as.numeric(state_data$DATE-state_data$DATE[1]-fourteen_days)
      # append to final data for plotting
      master_df = rbind(master_df,as.data.frame(state_data))}
  }
  # add a new column of moving average
  # otherwise interactive plot cannot show date
  master_df$newcd_norm_moving <- rollmean(master_df$Newcd_norm, window_num,
                                  fill=NA, align="right")
  event_master_df <- master_df[master_df$Events_mler!="",] 
  

  event_master_df$Events_mler <- factor(event_master_df$Events_mler,
                                        levels = c("Easing", "Restricting",
                                                   "Labor Day"))
  p <- ggplot() +
    geom_vline(xintercept=0) +
    geom_line(data = master_df, aes(x = Days, y = newcd_norm_moving,
                                    color = STATE), size = 1, alpha = 0.8) +
    geom_point(data = event_master_df, aes(x = Days, y = newcd_norm_moving,
                                           shape=Events_mler),
               alpha = 1, size=4) +
    scale_color_discrete(name="State")+
    scale_shape_manual(name="Event Categories", values=c(16,17,4))+
    xlim(c(-14,100))+
    ylim(c(0,y_axis_max))+
    xlab(paste("Number of Days Since", event_order_name))+
    ylab("Normalized Daily New Cases") +
    ggtitle( paste("The Last Time", event_order_name, "Issued After May, 2020", sep = " ") ) +
    theme_bw()+
    theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        title=element_text(size=16, face='bold'),
        legend.title=element_text(size=14, face="bold"),
        legend.text=element_text(size=12),
        legend.margin=margin(t = 0, unit='cm'))
  p
}

```

4. Create a function to plot first time for all states
```{r}
plot_all_first_issue <- function(states, window_num, y_axis_max,
                                 event_order, event_order_name){
  master_df = data.frame()
  school_opening_df = data.frame()
  states <- toupper(state.name)
  states <- append(states,"DISTRICT OF COLUMBIA")
  for (i in (1: length(states))){
    state_data <- data[data$STATE==states[i],]
    fourteen_days <- 14 # graph starts two weeks before 
    may_day <- as.Date("2020-05-01")
    state_data <- state_data[state_data$DATE>=may_day-fourteen_days,]
    state_data <- state_data %>%
    group_by(STATE, DATE) %>%
    summarise(Events = paste(EVENT_CATG_S, collapse = ","),
              Newcd_norm = mean(NEWCD_NORM_500),
              Events_mler = first(event_MLER),
              Score = mean(SCORE))
    
    # turn "NA" into NA
    state_data$Events[state_data$Events=="NA"] <- NA
    # index of first time issue of an order
    order_ind = which(sapply(state_data$Events, check_event, event_order))
  
    # if a state never issues mask order we don't plot it
    # else the plot starts at the day of mask order
    if(length(order_ind)>0 && order_ind>14){
      state_data = state_data[(order_ind-fourteen_days):nrow(state_data),]
      # number of days since implementation
      state_data$Days =
        as.numeric(state_data$DATE-state_data$DATE[1]-fourteen_days)
      # append to final data for plotting
      master_df = rbind(master_df,as.data.frame(state_data))}
  }
  # add a new column of moving average
  # otherwise interactive plot cannot show date
  master_df$newcd_norm_moving <- rollmean(master_df$Newcd_norm, window_num,
                                  fill=NA, align="right")
  event_master_df <- master_df[master_df$Events_mler!="",] 
  event_master_df$Events_mler <- factor(event_master_df$Events_mler,
                                        levels = c("Easing", "Restricting",
                                                   "Labor Day"))

  
  p <- ggplot() +
    geom_vline(xintercept=0) +
    geom_line(data = master_df, aes(x = Days, y = newcd_norm_moving,
                                    color = STATE), size = 1, alpha = 0.8) +
    geom_point(data = event_master_df, aes(x = Days,
                                           y = newcd_norm_moving,
                                           shape=Events_mler),
               alpha = 1, size=4) +
    scale_shape_manual(name="Event Categories", values=c(16,17,4))+
    scale_color_manual(values=rep("red", 46),labels=rep("", 46))+
    xlim(c(-14,100))+
    ylim(c(0,y_axis_max))+
    #scale_x_continuous(breaks = seq(-10,100, by = 20))+
    xlab(paste("Number of Days Since", event_order_name))+
    ylab("Normalized Daily New Cases") +
    ggtitle( paste("The First Time", event_order_name, "Issued After May, 2020", sep = " ") ) +
    theme_bw()+
    theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        title=element_text(size=16, face='bold'),
        legend.title=element_text(size=14, face="bold"),
        legend.text=element_text(size=12),
        legend.margin=margin(t = 0, unit='cm'))
  p
}
```


5. Create a function to plot last time for all states
```{r, warning=FALSE}
plot_all_last_issue <- function(states, window_num, y_axis_max,
                                 event_order, event_order_name){
  master_df = data.frame()
  school_opening_df = data.frame()
  states <- toupper(state.name)
  states <- append(states,"DISTRICT OF COLUMBIA")
  for (i in (1: length(states))){
    state_data <- data[data$STATE==states[i],]
    fourteen_days <- 14 # graph starts two weeks before 
    may_day <- as.Date("2020-05-01")
    state_data <- state_data[state_data$DATE>=may_day-fourteen_days,]
      state_data <- state_data %>%
    group_by(STATE, DATE) %>%
    summarise(Events = paste(EVENT_CATG_S, collapse = ","),
              Newcd_norm = mean(NEWCD_NORM_500),
              Events_mler = first(event_MLER),
              Score = mean(SCORE))
    
    # turn "NA" into NA
    state_data$Events[state_data$Events=="NA"] <- NA
    # index of first time issue of an order
    order_ind = which(sapply(state_data$Events, check_event, event_order))
    last_issue <- order_ind
    if (length(order_ind)>0){
      for (i in order_ind:nrow(state_data)){
        if (check_event(state_data[i,"Events"]$Events, event_order)){
          last_issue <- i
      }
    }
      
    }

  
    # if a state never issues mask order then plot all data
    # else the plot starts at the day of mask order
    if(length(last_issue)>0){
      state_data = state_data[(last_issue-fourteen_days):nrow(state_data),]
      # number of days since implementation
      state_data$Days =
        as.numeric(state_data$DATE-state_data$DATE[1]-fourteen_days)
      # append to final data for plotting
      master_df = rbind(master_df,as.data.frame(state_data))}
  }
  
  
  # add a new column of moving average
  # otherwise interactive plot cannot show date
  master_df$newcd_norm_moving <- rollmean(master_df$Newcd_norm, window_num,
                                  fill=NA, align="right")
  event_master_df <- master_df[master_df$Events_mler!="",] 
  

  event_master_df$Events_mler <- factor(event_master_df$Events_mler,
                                        levels = c("Easing", "Restricting",
                                                   "Labor Day"))
  p <- ggplot() +
    geom_vline(xintercept=0) +
    geom_line(data = master_df, aes(x = Days, y = newcd_norm_moving,
                                    color = STATE), size = 1, alpha = 0.8) +
    geom_point(data = event_master_df, aes(x = Days, y = newcd_norm_moving,
                                           shape=Events_mler),
               alpha = 1, size=4) +
    scale_color_manual(values=rep("red", 49),labels=rep("", 46))+
    scale_shape_manual(name="Event Categories", values=c(16,17,4))+
    xlim(c(-14,100))+
    ylim(c(0,y_axis_max))+
    xlab(paste("Number of Days Since", event_order_name))+
    ylab("Normalized Daily New Cases") +
    ggtitle( paste("The Last Time", event_order_name, "Issued After May, 2020", sep = " ") ) +
    theme_bw()+
    theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        title=element_text(size=16, face='bold'),
        legend.title=element_text(size=14, face="bold"),
        legend.text=element_text(size=12),
        legend.margin=margin(t = 0, unit='cm'))
  p
}
```


***************************************************************************
***************************************************************************
Modify and run this code chunk to create static event comparison graphs
Run this code chunk to get implementing an order for the first time
```{r, message=FALSE, warning=FALSE}
# identify which individual state
states=c("WISCONSIN", "TEXAS", "UTAH", "WASHINGTON", "NEW YORK")
#states = toupper("South Dakota")
#states="All"
# identify order 
event_order = "15M"
# identify event order full name for x-label
event_order_name = "Mask Mandate"
# identify the window(days) for moving averages
window_num = 7
# identify the upper limit of y axis
y_axis_max = 700

# function to plot first time issue order, no need to change
png(filename="Static_Event_Comparison_First_Time.png", width=1120, height=600)
if (states=="All"){
  plot_all_first_issue(states, window_num, y_axis_max, event_order,
                 event_order_name)
} else {
  plot_first_issue(states, window_num, y_axis_max, event_order,
                 event_order_name)
}
dev.off()
# function to plot first time issue order, no need to change
# png(filename="Static_Event_Comparison_Last_Time.png", width=1120,
#     height=600)
# plot_last_issue(states, window_num, y_axis_max, event_order,
#                  event_order_name)
# dev.off()

```

Run this code chunk to get implementing an order for the last time
```{r, message=FALSE, warning=FALSE}
# identify which individual state
states=c("WISCONSIN", "TEXAS", "UTAH", "WASHINGTON", "NEW YORK")
#states="All"
# identify order 
event_order = "4E"
# identify event order full name for x-label
event_order_name = "Restaurant and/or Bar Easing"
# identify the window(days) for moving averages
window_num = 7
# identify the upper limit of y axis
y_axis_max = 700

# function to plot first time issue order, no need to change
png(filename="Static_Event_Comparison_Last_Time.png", width=1120, height=600)
if (states=="All"){
  plot_all_last_issue(states, window_num, y_axis_max, event_order,
                 event_order_name)
} else {
  plot_last_issue(states, window_num, y_axis_max, event_order,
                 event_order_name)
}
dev.off()
# function to plot first time issue order, no need to change
# png(filename="Static_Event_Comparison_Last_Time.png", width=1120,
#     height=600)
# plot_last_issue(states, window_num, y_axis_max, event_order,
#                  event_order_name)
# dev.off()

```